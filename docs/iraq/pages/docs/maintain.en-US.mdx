
# Maintain

Type of maintenance activities

| Activity | Comments |
|---|---|
| 1. Backup data and patient files | Automated, nightly, locally on production |
| 2. Synchronize production data with QA and DEV environments | Manual, from GitHub Sync actions |
| 3. Upgrade binaries | Manual, from GitHub Build actions |
| 4. Update metadata and configurations | Manual, from GitHub Build actions |

## Backup

### Overview

<div>
<img src="/backup-diagram.png" width="50%"/>
</div>


#### Instructions to backup the database on a daily or weekly basis, encrypt it, and transfer to another location:

### Prerequisites

#### Step 1: Install GPG on the backup server

You can install GPG on your backup server using your distribution's package manager. For example, on Ubuntu or Debian, you can use the following command:
```shell
sudo apt-get update
sudo apt-get install gnupg
```

#### Step 2: Generate a GPG key pair

You can generate a GPG key pair using the following command:

```shell
gpg --gen-key
```

This will launch a series of prompts to configure your key pair. Follow the prompts to create your key pair.

#### Step 3: Export the public key

Once you have generated your key pair, you need to export the public key and share it with the users who will be encrypting backups for you.

You can export the public key using the following command:

```shell
gpg --export -a "Your Name" > public_key.asc
```
Replace "Your Name" with the name you used when generating your key pair.

#### Step 4: Encrypt backups using GPG

To encrypt a backup using GPG, you can use the following command:

```shell
gpg --encrypt --recipient "Your Name" backup_file.tar.gz
```
Replace "Your Name" with the name associated with your GPG key pair, and replace "backup_file.tar.gz" with the name of your backup file.

### Consolidated script 

```shell
#!/bin/bash

# Set the date format
now=$(date +"%Y_%m_%d")

# Perform daily incremental backup of the database
docker exec openmrs-db /usr/bin/mysqldump --max_allowed_packet=51012M -u '****' --password='******' openmrs --skip-lock-tables --single-transaction --skip-triggers | gzip -v > /openmrs/backup/lime_dc_db_daily_$now.sql.gz

# Perform weekly incremental backup of the database
if [ $(date +%u) -eq 7 ]; then
  docker exec openmrs-db /usr/bin/mysqldump --max_allowed_packet=51012M -u '****' --password='******' openmrs --skip-lock-tables --single-transaction --skip-triggers | gzip -v > /openmrs/backup/lime_dc_db_weekly_$now.sql.gz
fi

# Encrypt backup file using GPG
gpg --encrypt --recipient "Your Name" /ptracker/backup/ptracker_dc_db.sql.gz

# Perform incremental backup of the storage and files
rsync -a --delete /lime/storage/ backup@172.24.xx.xx:/openmrs/backup/lime_dc_storage/

# Perform incremental backup of the OpenMRS files
rsync -a --delete /lime/openmrs/ backup@172.24.xx.xx:/openmrs/backup/lime_dc_files/

# Create a log message with timestamp
echo "$(date): Daily and weekly incremental backup of OpenMRS database and incremental backup of storage and files has been performed."
```
This script performs a MySQL dump of an OpenMRS database, compresses the output and transfers it to a backup server. It also adds a time stamp message to a log file.

### Line-by-line explanation of the script

```now=$(date +"%Y_%m_%d")```: This line creates a variable now that captures the current date in the format of year, month, and day.

```shell docker exec ptracker-openmrs-db /usr/bin/mysqldump --max_allowed_packet=51012M -u '****' --password='******' openmrs --skip-lock-tables | gzip -v > /lime/backup/lime_dc_db.sql.gz```: This line uses Docker to execute a MySQL dump command with specific parameters. It dumps the database named openmrs to the standard output and pipes it to gzip, which compresses the output. The compressed output is then redirected to a backup file named ptracker_dc_db.sql.gz in the /ptracker/backup/ directory.

```scp -i '/openmrs/backup/backup_key' /openmrs/backup/lime_dc_db.sql.gz backup@172.24.xx.xx:/openmrs/backup/lime_dc_db_$now.sql.gz```: This line uses scp to securely copy the backup file to a backup server. It uses the key stored in /lime/backup/backup_key to authenticate the transfer. The file is transferred to the user backup at IP address 172.24.xx.xx, and it is renamed to include the timestamp variable $now in the file name.

```echo $now Backup of openmrs db has run```: This line appends a message to a log file that confirms that the backup has been run. The message includes the timestamp variable $now.


## Deitentify

## Restore

## Update 

Type of updates:
1. Binaries (OpenMRS files) - updated by Build actions
2. Metadata and configuration - updated by Configuration actions
3. Local data update - done manually by project team

Latest images can be pulled on instances using the Docker command:
```shell
docker-compose pull && docker-compose up -d
```
